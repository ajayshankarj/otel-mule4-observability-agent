= Mule 4 OpenTelemetry (OTel) Agent Extension
// Document header
Rick Bansal <rick.bansal@mulesoft.com>
:revnumber: 1.0.92-SNAPSHOT
:revdate: Feb. 19, 2022
:revremark: Initial Draft
:doctype: book
:icons: font
:toc: left
:imagesdir: ./Images
:keywords: Mule, MuleSoft, Observability, OpenTelemetry, OTel, Tracing, Instrumentation, Distributed

// The following pass through will align the images and their titles
ifndef::env-github[]
++++
<style>
  .imageblock > .title {
    text-align: inherit;
    margin-top: 10px;
  }
</style>
++++
endif::[]

ifdef::env-github[]
:caution-caption: :fire:
:important-caption: :heavy_exclamation_mark:
:note-caption: :information_source:
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]



// Document body
== Introduction

The Mule 4 OTel Agent is a custom MuleSoft *extension* for instrumenting MuleSoft applications to export tracing 
specific *telemetry* data to any OpenTelemetry compliant collector.  Using the agent now allows Mule applications 
to be insightful participants in the overall *distributed trace*.

== The Why on the OTel Mule 4 Agent

The motivation behind developing this extension is predicated on *two primary concerns* as it 
relates to enterprise software:

* Composability
* Observability

=== Composability

.What exactly is composability and why does it matter?

Well, as you might imagine, there are plenty of 
theoretical, complex and technical answers to this question - just Google it to get a list of the numerous publications
on the topic. Since this is not a technical article on the subject of composability, we'll take a much more modest view of it.

So, in really simple terms, *_composability_* is the concept of building stand alone software *composed* of 
other stand alone software, in a plug-and-play manner (see figure <<Composable-enterprise-app-1>> below) and it matters because 
enterprises who adopt composability as a core IT practice can achieve much greater *agility* on delivering new and/or enhanced 
solutions for business in the face of rapid and ever changing market conditions - does COVID ring a bell?  

[#Composable-enterprise-app-1]
image::Composable-enterprise-app-1.png[600, 600, title="Example of a Composite Application", align="center"]

Basically, the practice of composability is a great way for an enterprise to *protect* and *grow* overall *revenue* in 
the face of both expected and unexpected change. Do you know know when or what the next crisis will be?  Exactly...

=== Composable Enterprise

https://www.gartner.com/smarterwithgartner/gartner-keynote-the-future-of-business-is-composable[Gartner] 
defines a *_Composable Enterprise_* as an organization that can innovate and adapt to changing
business needs through the assembly and combination of packaged business capabilities.

[NOTE] 
====
Gartner's definition of composable business operates on four basic principles: 

* More speed through *discovery*.
* Greater agility through *modularity*.
* Better leadership through *orchestration*.
* Resilience through *autonomy*.
====

Composability must be important because it has its own Gartner definition, right?

==== So how long before we have true composable enterprises? 
 
From a purist standpoint (i.e., based on the Gartner definition), 
who knows - maybe never.  However, from a practical perspective the "messy" composable enterprise is *already here*, has been 
for a while and it's quickly getting more "pure" over time.

For example,

* A typical enterprise supports over *900 applications* and the number is *growing*, not shrinking.
** Growth is happening because of:
*** Accelerated implementation of *digital transformation strategies* with a cloud-first approach.
*** Rapid adoption of a *microservices* architecture paradigm.

* Typically, no single enterprise application handles a business transaction.
** A typical *business transaction traverses over 35 different systems/applications* from start to finish.
*** These systems/applications are often on a variety of *disparate* and independent *technologies* stacks - both legacy and modern.
*** These systems are often a combination of on-prem or hosted *packaged* applications (e.g., SAP ERP, Oracle HCM, Manhattan SCM, 
etc.), *custom* coded applications and *SaaS* applications (e.g., Salesforce, NetSuite, Workday, etc.)

So as you can see, the composable enterprise already exists and will, rapidly, become more composable over time, especially,
with the support of companies like MuleSoft, products like the Anypoint Platform and methodologies like API-Led Connectivity.

image::API-Led-1.png[title="API Led to Help Solve for Composability", align="center"]

////
Legos are often used has a metaphor for explaining the concept of composability.  Think of developing/constructing each 
application in your enterprise as a discrete lego with .  Then, using these discrete legos you can easily build more complex new
applications or rebuild more complex applicationsFrom these discrete blocks



image::Lego-blocks.png[600, 600, title="Application Legos", align="center"]
////


//image::MuleSoft-Solution-Composability.png[title="API Led for Composability", align="center"]



=== Observability

[quote]
Wikipedia defines *observability* as a measure of how well internal states of a system can be inferred from knowledge of 
its external outputs.  As it relates specifically to software, observability is the ability to collect data about program 
execution, internal states of modules, and communication between components.  This corpus of collected data is also referred 
to as *telemetry*.

Another way of looking at observability is having the capacity to introspect, in real-time, complex multi-tiered architectures to 
better answer the following when things so sideways:

* Where is it broken?
* Why did it break?
* Where is it slow?

Then, using those insights to fix what's broken and speedup what's slow.

[NOTE]
====
However, I think a *more important* consideration for observability is an answer to following:

* How can I *proactively* protect against failure and poor performance?
====

==== Observability Trinity

The obtainment of true observability relies upon 3 core pillars.

image::Pillars-of-Observability.png[600, 600, title="The 3 Pillars of Observability", align="center"]

===== Metrics
A *_metric_* is a value that expresses some information about a system. Metrics are 
usually represented as counts or measures, and are often aggregated or calculated over a period of time. Additionally, metrics 
are often structured as _<name, value>_ pairs that provide useful behavioral details at both the micro-level and the macro-level 
such as the following:

.Example Metrics
|===
| *Micro-level metrics*           | *Macro-level metrics*
| Memory utilization per service  | Average response time per service
| CPU utilization per service     | Throughput rate per service
| Thread count                    | Failure rate per service
| ...                             | ...
|===

image::Macro-Micro-Metrics.png[title="Micro-level and Macro-level Metrics", align="center"]

===== Logs
A *log* is an immutable, time-stamped text or binary record, either structured (recommended) or unstructured, potentially including 
metadata. The log record is generated application code in response to an event (e.g., an error condition) which has occurred
during execution.

.Example of a structured log record
 [/opt/mule/mule-CURRENT/logs/mule-nto-order-api-v1.log]: [02-22 08:02:50.412] ERROR OnErrorContinueHandler [ [MuleRuntime].uber.18543: [client-id-enforcement-439118-order-api-spec-main].439118-client-id-enforcement.CPU_LITE @5b1b413e] [event: d46fe7b0-93b5-11ec-b9b6-02d407c48f42]: 


.Example of a unstructured log record
 'hello world'

===== Traces
A *single trace* shows the activity for an individual transaction or request as it flows through an application. Traces are a 
critical part of observability, as they provide context for other telemetry. For example, traces can help define which metrics 
would be most valuable in a given situation, or which logs are relevant to a particular issue.

*Distributed tracing* is a method of observing requests as they propagate through distributed cloud environments. Distributed 
tracing follows an interaction by tagging it with a unique identifier. This identifier stays with the transaction as it interacts 
with microservices, containers, and infrastructure. The unique identifier offers real-time visibility into user experience, from 
the top of the stack to the application layer and the infrastructure beneath.

image::Distributed-Trace-Example.png[title="Example of a Distributed Trace", align="center"]

==== Why is observability important?  

The notion of observability is very important to IT organizations because when a business transaction fails or performs 
poorly within their application network, they need the ability to quickly triage and remediate the root cause before there is any
significant impact on revenue.  

Many IT organizations have and continue to rely upon commercial Application Performance Monitoring (APM) tools (e.g., AppDynamics, 
Dynatrace, New Relic, CA APM, ...) to help them in this regard.  While useful, these commercial tools have struggled in the past
to provide complete visibility into the overall distributed trace as they deploy vendor specific agents to collect their telemetry.
I say "struggled in the past" because many of the APM vendors are now starting to embrace and support open source standards like 
OpenTelemetry to help them fill in the "holes".

==== So what does composability and observability have to do with each other?  

Well, as enterprise applications become more and more 
composable, that is, as enterprises move towards composability, the need for observability becomes greater; however, the capacity 
for it becomes harder.

=== Solving for Observability

image::Solving-for-observability.png[800, 800, title="Observability = Anypoint Monitoring + Otel Mule 4 Agent", align="center"]



//image::TheInevitable-1.png[]



////
ifndef::env-github[:icons: font]
ifdef::env-github[]
:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :paperclip:aQZ`
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]
////
//:toc: macro

//toc::[]


== The What on the OTel Mule 4 Agent

=== OpenTelemetry

[quote, OpenTelemetry, 'https://opentelemetry.io']
OpenTelemetry *is a set* of APIs, SDKs, tooling and integrations that are designed for the creation and management 
of *telemetry data* such as traces, metrics, and logs. The project provides a *vendor-agnostic* implementation that 
can be configured to send telemetry data to the backend(s) of your choice.

IMPORTANT: OpenTelemetry *is not* an observability back-end.

The OpenTelemetry open-source project was established in 2019 and is spearheaded by the CloudNative Computing Foundation (CNCF), 
with the aim of making software more observable and to establish telemetry as a built-in feature of cloud-native software.

[NOTE]
====
In 2019, the https://opencensus.io/[OpenCensus] and https://opentracing.io/[OpenTracing] projects merged into OpenTelemetry. 
Currently, OpenTelemetry is at the "*incubating*" https://github.com/cncf/toc/blob/main/process/graduation_criteria.adoc[maturity 
level] (up from "sandbox" level a year back) and is one of the most popular projects across the CNCF landscape.
====

==== OpenTelemetry Reference Architecture

image::Otel-Ref-Arch-2-shadowing.png[800, 800, title="OpenTelemetry Reference Architecture", align="center"]


==== MuleSoft OpenTelemetry Agent Architecture

image::Agent-Arch.png[600, 600, title="Mule Agent Architecture", align="center"]


This *purpose* of this mule extension is to allow Mule Applications participate in OpenTelemetry-based distributed traces.

== The How on the OTel Mule 4 Agent



=== Installation Guideline

=== Configuration of the Agent

=== Example Scenario

=== Example Output - Dynatrace Backend

[bibliography]
== References
* https://www.w3.org/TR/trace-context/#dfn-distributed-traces[w3.org: "Distributed Traces"]
* https://opentelemetry.io/[opentelemetry.io]
* https://lightstep.com/observability/[Lightstep: "Observability: A complete overview for 2021"]
* https://www.dynatrace.com/resources/ebooks/observability-and-beyond-for-the-enterprise-cloud/[Dynatrace e-book:
"Observability and Beyond for the Enterprise Cloud"]
* https://www.splunk.com/en_us/form/beginners-guide-to-observability.html[Splunk e-book: "A Beginner's Guide to Observability"]
* https://docs.mulesoft.com/monitoring/[MuleSoft: "Anypoint Monitoring Overview"]

